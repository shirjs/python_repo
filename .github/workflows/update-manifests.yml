name: update deployment image
#
on:
  push:
    branches:
      - main

jobs:
  update-manifests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: get latest image tag
      id: get_tag
      run: |
        echo "IMAGE_TAG=$(curl -s https://hub.docker.com/v2/repositories/shirbenyosef1/flask_app/tags/?page_size=1 | jq -r '.results[0].name')" >> $GITHUB_OUTPUT
    
    - name: install yq
      run: |
        wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq && chmod +x /usr/local/bin/yq

          
    - name: update manifest
      run: |
        yq e '.spec.template.spec.containers[0].image = "shirbenyosef1/flask_app:${{ steps.get_tag.outputs.IMAGE_TAG }}"' -i deployment.yml
    
    - name: Commit and push changes
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add deployment.yml
        git commit -m "Update deployment image to ${{ steps.get_tag.outputs.IMAGE_TAG }}"
        git push